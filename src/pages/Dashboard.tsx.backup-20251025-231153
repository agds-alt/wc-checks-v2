// src/pages/Dashboard.tsx - IMPROVED NAVIGATION
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import { useQuery } from '@tanstack/react-query';
import { supabase } from '../lib/supabase';
import { 
  QrCode, 
  MapPin, 
  Calendar, 
  User,
  ChevronRight,
  Droplets,
  TrendingUp,
  Clock,
  CheckCircle2,
  AlertCircle,
  Settings
} from 'lucide-react';
import { BottomNav } from '../components/mobile/BottomNav';

export const Dashboard = () => {
  const { user, profile } = useAuth();
  const navigate = useNavigate();

  // Fetch user statistics
  const { data: stats, isLoading } = useQuery({
    queryKey: ['user-stats', user?.id],
    queryFn: async () => {
      const { data: inspections, error } = await supabase
        .from('inspection_records')
        .select('id, overall_status, inspection_date')
        .eq('user_id', user?.id)
        .order('inspection_date', { ascending: false });

      if (error) throw error;

      const total = inspections.length;
      const today = new Date().toISOString().split('T')[0];
      const todayCount = inspections.filter(i => i.inspection_date === today).length;
      const completed = inspections.filter(i => i.overall_status === 'completed').length;

      return {
        total,
        todayCount,
        completed,
        recent: inspections.slice(0, 3),
      };
    },
    enabled: !!user?.id,
  });

  // Fetch recent locations
  const { data: locations } = useQuery({
    queryKey: ['locations'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('locations')
        .select('id, name, building, floor')
        .eq('is_active', true)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) throw error;
      return data;
    },
  });

  const quickActions = [
    {
      title: 'Scan QR Code',
      description: 'Scan lokasi toilet',
      icon: QrCode,
      path: '/scan',
      color: 'blue',
      primary: true
    },
    {
      title: 'Locations',
      description: 'Kelola lokasi',
      icon: MapPin,
      path: '/locations',
      color: 'purple',
    },
    {
      title: 'Reports',
      description: 'Lihat laporan',
      icon: Calendar,
      path: '/reports',
      color: 'green',
    },
    {
      title: 'Profile',
      description: 'Pengaturan akun',
      icon: User,
      path: '/profile',
      color: 'orange',
    },
  ];

  const colorClasses = {
    blue: 'bg-blue-500 hover:bg-blue-600',
    purple: 'bg-purple-500 hover:bg-purple-600',
    green: 'bg-green-500 hover:bg-green-600',
    orange: 'bg-orange-500 hover:bg-orange-600',
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-24">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 pt-8">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-2xl font-bold">
              Hi, {profile?.full_name?.split(' ')[0] || 'User'}! ðŸ‘‹
            </h1>
            <p className="text-blue-100 text-sm mt-1">
              Ready for inspection today?
            </p>
          </div>
          <button 
            onClick={() => navigate('/profile')}
            className="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center"
          >
            <Settings className="w-5 h-5" />
          </button>
        </div>

        {/* Stats Grid */}
        {isLoading ? (
          <div className="grid grid-cols-3 gap-3">
            {[1, 2, 3].map(i => (
              <div key={i} className="bg-white/10 backdrop-blur-sm rounded-2xl p-4 h-20 animate-pulse" />
            ))}
          </div>
        ) : (
          <div className="grid grid-cols-3 gap-3">
            <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
              <div className="text-3xl font-bold">{stats?.total || 0}</div>
              <div className="text-xs text-blue-100 mt-1">Total</div>
            </div>
            <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
              <div className="text-3xl font-bold">{stats?.todayCount || 0}</div>
              <div className="text-xs text-blue-100 mt-1">Today</div>
            </div>
            <div className="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
              <div className="text-3xl font-bold">{stats?.completed || 0}</div>
              <div className="text-xs text-blue-100 mt-1">Done</div>
            </div>
          </div>
        )}
      </div>

      <main className="p-6 space-y-6">
        {/* Quick Actions */}
        <div>
          <h2 className="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
          <div className="grid grid-cols-2 gap-3">
            {quickActions.map((action) => {
              const Icon = action.icon;
              return (
                <button
                  key={action.path}
                  onClick={() => navigate(action.path)}
                  className={`
                    ${action.primary ? 'col-span-2' : ''}
                    ${action.primary ? colorClasses[action.color as keyof typeof colorClasses] : 'bg-white'}
                    ${action.primary ? 'text-white' : 'text-gray-900'}
                    ${action.primary ? 'p-6' : 'p-4'}
                    rounded-2xl shadow-sm
                    transition-all duration-200
                    hover:shadow-md
                    active:scale-95
                  `}
                >
                  <div className="flex items-center gap-3">
                    <div className={`
                      ${action.primary ? 'w-14 h-14 bg-white/20' : 'w-12 h-12 bg-gray-100'}
                      rounded-xl flex items-center justify-center flex-shrink-0
                    `}>
                      <Icon className={`w-6 h-6 ${action.primary ? '' : 'text-gray-700'}`} />
                    </div>
                    <div className="text-left">
                      <div className="font-semibold">{action.title}</div>
                      <div className={`text-xs mt-0.5 ${action.primary ? 'text-white/80' : 'text-gray-500'}`}>
                        {action.description}
                      </div>
                    </div>
                  </div>
                </button>
              );
            })}
          </div>
        </div>

        {/* Recent Locations */}
        {locations && locations.length > 0 && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold text-gray-900">Recent Locations</h2>
              <button 
                onClick={() => navigate('/locations')}
                className="text-sm text-blue-600 font-medium"
              >
                View All
              </button>
            </div>
            <div className="space-y-2">
              {locations.map((location) => (
                <button
                  key={location.id}
                  onClick={() => navigate(`/inspect/${location.id}`)}
                  className="w-full flex items-center justify-between p-4 bg-white rounded-xl hover:bg-gray-50 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                      <MapPin className="w-5 h-5 text-purple-600" />
                    </div>
                    <div className="text-left">
                      <div className="font-medium text-gray-900">{location.name}</div>
                      <div className="text-sm text-gray-500">
                        {location.building} â€¢ {location.floor}
                      </div>
                    </div>
                  </div>
                  <ChevronRight className="w-5 h-5 text-gray-400" />
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Recent Inspections */}
        {stats?.recent && stats.recent.length > 0 && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold text-gray-900">Recent Inspections</h2>
              <button 
                onClick={() => navigate('/reports')}
                className="text-sm text-blue-600 font-medium"
              >
                View All
              </button>
            </div>
            <div className="space-y-2">
              {stats.recent.map((inspection: any) => (
                <div
                  key={inspection.id}
                  className="flex items-center gap-3 p-4 bg-white rounded-xl"
                >
                  <div className="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                    <Droplets className="w-5 h-5 text-blue-600" />
                  </div>
                  <div className="flex-1">
                    <div className="font-medium text-gray-900">
                      {new Date(inspection.inspection_date).toLocaleDateString('id-ID', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                      })}
                    </div>
                    <div className="text-sm text-gray-500">
                      {inspection.overall_status === 'completed' ? 'Completed' : 'Pending'}
                    </div>
                  </div>
                  {inspection.overall_status === 'completed' ? (
                    <CheckCircle2 className="w-5 h-5 text-green-500" />
                  ) : (
                    <Clock className="w-5 h-5 text-orange-500" />
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Empty State */}
        {(!stats || stats.total === 0) && !isLoading && (
          <div className="text-center py-12">
            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <QrCode className="w-10 h-10 text-gray-400" />
            </div>
            <h3 className="text-lg font-semibold text-gray-900 mb-2">
              No Inspections Yet
            </h3>
            <p className="text-gray-500 mb-6">
              Start your first inspection by scanning a QR code
            </p>
            <button
              onClick={() => navigate('/scan')}
              className="px-6 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors"
            >
              Scan QR Code
            </button>
          </div>
        )}
      </main>

      <BottomNav />
    </div>
  );
};