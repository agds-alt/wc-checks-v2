<!DOCTYPE html>
<html>
<head>
    <title>Auth Test</title>
    <script>
        async function testAuth() {
            const log = document.getElementById('log');

            try {
                // 1. Login
                log.innerHTML += '1. Testing login...\n';
                const loginRes = await fetch('http://localhost:3000/api/trpc/auth.login?batch=1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "0": {
                            "json": {
                                "email": "demo@test.com",
                                "password": "password123"
                            }
                        }
                    })
                });

                const loginData = await loginRes.json();
                log.innerHTML += JSON.stringify(loginData, null, 2) + '\n\n';

                const token = loginData[0]?.result?.data?.json?.token;
                if (!token) {
                    log.innerHTML += 'ERROR: No token received\n';
                    return;
                }

                log.innerHTML += '✓ Login successful! Token: ' + token.substring(0, 50) + '...\n\n';

                // 2. Test protected endpoint
                log.innerHTML += '2. Testing protected /auth.me endpoint...\n';
                const meRes = await fetch('http://localhost:3000/api/trpc/auth.me?batch=1&input=%7B%220%22%3A%7B%7D%7D', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const meData = await meRes.json();
                log.innerHTML += JSON.stringify(meData, null, 2) + '\n\n';

                if (meData[0]?.result?.data?.json) {
                    log.innerHTML += '✓ Authentication working! User data retrieved successfully!\n';
                } else {
                    log.innerHTML += 'ERROR: Protected endpoint failed\n';
                }

            } catch (error) {
                log.innerHTML += 'ERROR: ' + error.message + '\n';
            }
        }
    </script>
</head>
<body>
    <h1>tRPC Auth Test</h1>
    <button onclick="testAuth()">Test Authentication Flow</button>
    <pre id="log" style="background: #f5f5f5; padding: 20px; margin-top: 20px;"></pre>
</body>
</html>
